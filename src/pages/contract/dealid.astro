
---
import type { Deal } from "../../lib/store";
import { getJSON } from "../../lib/db";
import { monthlyPayment, formatMoney } from "../../lib/finance";

const { dealId } = Astro.params;

const deals = await getJSON<Deal[]>("deals", []);
const deal = deals.find((d) => d.id === dealId);

const today = deal ? new Date(deal.acceptedAt).toLocaleDateString() : "";
const payment = deal ? monthlyPayment(deal.principal, deal.apr, deal.termMonths) : 0;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{deal ? `Loan Agreement — ${deal.id}` : "Contract not found"}</title>
    <style>
      body { font-family: ui-serif, Georgia, "Times New Roman", Times, serif; margin: 0; padding: 28px; max-width: 900px; margin-inline: auto; }
      h1, h2 { font-family: system-ui; }
      .box { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fafafa; }
      .muted { color: #444; font-family: system-ui; }
      ul { margin-top: 6px; }
      .siggrid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-top: 18px; }
      .sig { border-top: 1px solid #333; padding-top: 10px; }
      @media print { .noprint { display: none; } body { padding: 0; } }
    </style>
  </head>
  <body>
    {deal ? (
      <>
        <div class="noprint muted">
          <p><a href={`/requests/${deal.requestId}`}>← Back to request</a></p>
          <button onclick="window.print()">Print / Save as PDF</button>
          <p><strong>Note:</strong> This is a generated template. Have a qualified lawyer review it.</p>
        </div>

        <h1>Loan Agreement</h1>
        <p class="muted">Agreement Date: {today} • Deal ID: {deal.id}</p>

        <div class="box">
          <h2>Parties</h2>
          <p><strong>Lender:</strong> {deal.lender.name} ({deal.lender.email})</p>
          <p><strong>Borrower:</strong> {deal.borrower.name} ({deal.borrower.email})</p>
        </div>

        <h2>1. Loan Terms</h2>
        <ul>
          <li><strong>Principal:</strong> {formatMoney(deal.principal, deal.currency)}</li>
          <li><strong>APR:</strong> {deal.apr}% (annual)</li>
          <li><strong>Term:</strong> {deal.termMonths} months</li>
          <li><strong>Origination fee:</strong> {formatMoney(deal.originationFee, deal.currency)}</li>
          <li><strong>Repayment schedule:</strong> {deal.schedule}</li>
          <li><strong>Estimated monthly payment:</strong> {formatMoney(payment, deal.currency)}</li>
        </ul>

        <h2>2. Governing Law</h2>
        <p>This Agreement is governed by the laws of <strong>{deal.governingLaw}</strong>.</p>

        <h2>3. Signatures</h2>
        <div class="siggrid">
          <div>
            <div class="sig"><strong>Lender Signature</strong></div>
            <div>Name: {deal.lender.name}</div>
            <div>Date: ____________________</div>
          </div>
          <div>
            <div class="sig"><strong>Borrower Signature</strong></div>
            <div>Name: {deal.borrower.name}</div>
            <div>Date: ____________________</div>
          </div>
        </div>
      </>
    ) : (
      <div class="box">
        <h1>Contract not found</h1>
        <p class="muted">This deal ID does not exist.</p>
        <p class="muted"><a href="/lend">Go back to /lend</a></p>
      </div>
    )}
  </body>
</html>
